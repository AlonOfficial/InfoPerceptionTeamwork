<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <meta name="description" content="Draw lines and polygons on terrain with mouse clicks.">
    <meta name="cesium-sandcastle-labels" content="Showcases">
    <title>Cesium Demo</title>
    <script type="text/javascript" src="Sandcastle/Sandcastle-header.js"></script>
    <script src="jquery-3.5.1.min.js"></script>
    <script type="text/javascript" src="guiji.js" ></script>
    <script
      type="text/javascript"
      src="Build/CesiumUnminified/Cesium.js"
      
    ></script>

  </head>
  <body
    class="sandcastle-loading"
    data-sandcastle-bucket="bucket-requirejs.html"
  >

<style>
      @import url(Sandcastle/templates/bucket.css);
    </style>
    <div id="cesiumContainer" class="fullSize"></div>
    <div id="loadingOverlay"><h1>Loading...</h1></div>
    <div id="toolbar">
        <table class="infoPanel">
            <tbody>
              <tr>
                <td>单击左键开始绘制隔离范围</td>
              </tr>
              <tr>
                <td>双击左键确定结果</td>
              </tr>
            </tbody>
          </table>
    </div>

<script id="cesium_sandcastle_script">   

function startup(Cesium) {
    'use strict';
//初始化沙盒
var activeShapePoints = [];
var activeShape;
var floatingPoint;
//设置默认地图为open street map
var osm = new Cesium.OpenStreetMapImageryProvider({
        url : 'https://a.tile.openstreetmap.org/'
    });

var viewer = new Cesium.Viewer('cesiumContainer', {
    selectionIndicator: false,
    infoBox: false,
    //terrainProvider: Cesium.createWorldTerrain(),
    imageryProvider: osm
});
var handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
//设置默认位置为武汉大学信息学部
viewer.camera.setView({
  destination:Cesium.Cartesian3.fromDegrees(114.35412807424511,30.53130049933386,1500.0), 
})

// 获取数据
let did = '88010E2005002F5A';
let utcBegin = '1608566400000';
let utcEnd =   '1608647227423';

//绘制矩形，先由鼠标左键绘制点，两点确定范围，再由右键确定结果

//绘制保存的隔离区
var storage=window.localStorage;
var json;
if(json=storage.getItem(did))
{
    json = JSON.parse(json);
    console.log(json.west);
    viewer.entities.add({
        id:"quarantine",
        name: 'Blue translucent, rotated, and extruded ellipse with outline',
        rectangle : {
            coordinates :  new Cesium.CallbackProperty(function () {
                var obj=Cesium.Rectangle.fromRadians(json.west,json.south,json.east,json.north);
                //storage.setItem(did,arr);
                    return obj;
            }, false),
            material : Cesium.Color.RED.withAlpha(0.5)
        }
    });
}

//获取轨迹数据，同时判断每个点是否出界
var data = getData(did, utcBegin, utcEnd);
console.log(data);
var pA = getPointEntities(data);
var test = viewer.entities.getById('quarantine').rectangle.coordinates.getValue(Cesium.JulianDate.now());
//if(quarantine=Cesium.Rectangle.fromCartesianArray(viewer.entities.getById('quarantine').rectangle.coordinates.getValue(Cesium.JulianDate.now())))
//仅在用户有储存好的隔离区时进行判断
if(json)
{
    var quarantine=Cesium.Rectangle.fromRadians(json.west,json.south,json.east,json.north);
    for (var i=0; i<pA.length; i++){
        var test = Cesium.Cartographic.fromCartesian(pA[i].position.getValue(Cesium.JulianDate.now()));
        if(Cesium.Rectangle.contains(quarantine, test))
        {
            viewer.entities.add(pA[i]);
        }
        else{
            pA[i].point.color = Cesium.Color.RED;
            viewer.entities.add(pA[i]);
        }
    };
}
// for (var i=0; i<pA.length; i++){
//     viewer.entities.add(pA[i]);
// };
var lc = getLineCzml(data);
var dataSourcePromise = Cesium.CzmlDataSource.load(lc);
viewer.dataSources.add(dataSourcePromise);


//绘制点
function createPoint(worldPosition) {
    var point = viewer.entities.add({
        position: worldPosition,
        point: {
            color: Cesium.Color.WHITE,
            pixelSize: 5,
            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
        }
    });
    return point;
}
//绘制图形
function drawShape(positionData) {
    var shape;    
    var arr = typeof positionData.getValue === 'function' ? positionData.getValue(0) : positionData;
    shape = viewer.entities.add({
        name: 'Blue translucent, rotated, and extruded ellipse with outline',
        rectangle : {
            coordinates :  new Cesium.CallbackProperty(function () {
                var obj=Cesium.Rectangle.fromCartesianArray(arr);
                 return obj;
            }, false),
            material : Cesium.Color.RED.withAlpha(0.5)
        }
    });
    return shape;
}
//确定结果
function terminateShape() {
    var shape;
    activeShapePoints.pop();//去除最后一个动态点
    if(activeShapePoints.length){
       shape = drawShape(activeShapePoints);//绘制最终图
       //console.log(shape);
       var json={
        west:shape.rectangle.coordinates.getValue().west,
        south:shape.rectangle.coordinates.getValue().south, 
        east:shape.rectangle.coordinates.getValue().east,
        north:shape.rectangle.coordinates.getValue().north
       }
       storage.setItem(did,JSON.stringify(json))
    }
    viewer.entities.remove(floatingPoint);//去除动态点图形（当前鼠标点）
    viewer.entities.remove(activeShape);//去除动态图形
    floatingPoint = undefined;
    activeShape = undefined;
    activeShapePoints = [];
}

//鼠标左键选点
handler.setInputAction(function (event) {
    var earthPosition = viewer.camera.pickEllipsoid(event.position);
    if (Cesium.defined(earthPosition)) {
        if (activeShapePoints.length === 0) {
            floatingPoint = createPoint(earthPosition);
            activeShapePoints.push(earthPosition);
            var dynamicPositions = new Cesium.CallbackProperty(function () {
                return activeShapePoints;
            }, false);
            activeShape = drawShape(dynamicPositions);//绘制动态图 
        }
        activeShapePoints.push(earthPosition);
        createPoint(earthPosition);
    }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);
//鼠标移动选范围
handler.setInputAction(function (event) {
    if (Cesium.defined(floatingPoint)) {
        var newPosition = viewer.camera.pickEllipsoid(event.endPosition);
        if (Cesium.defined(newPosition)) {
            floatingPoint.position.setValue(newPosition);
            activeShapePoints.pop();
            activeShapePoints.push(newPosition);
        }
    }
}, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
//鼠标左键双击确定结果
handler.setInputAction(function (event) {
    terminateShape();
}, Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);





var options = [{
    text: 'Draw Circle',
    onselect: function () {
        terminateShape();
        drawingMode = 'circle';
    }

}];
var options2 = [{
    text: 'deviceID',
}];

function createButtons(scene) {

    Sandcastle.addToolbarMenu(options);
    Sandcastle.addToolbarMenu(options2);
    Sandcastle.addDefaultToolbarButton("Satellites", function () {});

    document.getElementById("toolbar").style.width = "20%";
}
var scene = viewer.scene;
createButtons(scene);

// Zoom in to an area with mountains


//viewer.camera.lookAt(Cesium.Cartesian3.fromDegrees(114, 31, 1000.0), new Cesium.Cartesian3(5000.0, 5000.0, 5000.0));
//viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);
//Sandcastle_End
    Sandcastle.finishedLoading();
}

if (typeof Cesium !== 'undefined') {
    window.startupCalled = true;
    startup(Cesium);
}
</script>
</body>
</html>
